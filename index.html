<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>究极方块世界 (单文件 10k+ 行修正 v1.6 - Final Order Fix)</title>
    <style>
        /* --- 基本样式 --- */
        body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 12px; }
        canvas { display: block; }

        /* --- UI 容器 --- */
        #uiContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* --- 游戏内 HUD --- */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background-color: rgba(255, 255, 255, 0.8); border: 1px solid black; border-radius: 50%; transform: translate(-50%, -50%); }
        #hotbar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; background-color: rgba(0, 0, 0, 0.5); padding: 3px; border-radius: 3px; pointer-events: all; border: 1px solid #444; }
        .slot { width: 38px; height: 38px; border: 2px solid #555; margin: 1px; background-color: rgba(100, 100, 100, 0.6); background-size: 80%; background-repeat: no-repeat; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-end; position: relative; overflow: hidden; user-select: none; cursor: pointer; image-rendering: pixelated; /* Ensure item textures are sharp */ }
        .slot.selected { border-color: #fff; background-color: rgba(150, 150, 150, 0.8); }
        .slot .item-count { font-size: 10px; color: white; text-shadow: 1px 1px 1px black; padding: 0 2px; position: absolute; bottom: 1px; right: 1px; }
        .slot .item-durability { position: absolute; bottom: 1px; left: 1px; width: calc(100% - 2px); height: 3px; background-color: rgba(0, 0, 0, 0.5); border-radius: 1px; }
        .slot .item-durability-bar { height: 100%; background-color: lime; width: 100%; border-radius: 1px; transition: width 0.1s linear, background-color 0.2s linear; }
        .slot[data-block-id="0"] { background-image: none; }

        /* --- 信息面板 --- */
        #infoPanel { position: absolute; top: 5px; right: 5px; background-color: rgba(0, 0, 0, 0.6); padding: 5px 8px; border-radius: 3px; font-size: 10px; text-align: right; line-height: 1.1; border: 1px solid #333; min-width: 180px; }

        /* --- 屏幕中心消息 --- */
        #message { display: none; position: absolute; top: 40%; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 5px; font-size: 14px; z-index: 99; text-align: center; }

        /* --- 加载屏幕 --- */
        #loading { position: fixed; /* Use fixed to ensure it covers everything */ top: 0; left: 0; width: 100%; height: 100%; background-color: #111; color: #eee; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 16px; }
        #loading-text { margin-bottom: 15px; font-size: 18px; }
        #loading-subtext { font-size: 12px; color: #bbb; height: 1.2em; margin-bottom: 10px; }
        #loading-progress { width: 60%; max-width: 400px; height: 12px; background-color: #444; border-radius: 6px; overflow: hidden; border: 1px solid #222; }
        #loading-progress-bar { width: 0%; height: 100%; background-color: #5cb85c; /* Green */ transition: width 0.2s ease-out; }

        /* --- 游戏菜单/UI 窗口 --- */
        .ui-window { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(25, 25, 25, 0.9); border: 2px solid #777; border-radius: 5px; padding: 15px; z-index: 50; pointer-events: all; box-shadow: 0 5px 20px rgba(0,0,0,0.6); min-width: 300px; color: #ccc; }
        .ui-window h2 { margin: -5px -5px 10px -5px; /* Extend to edges */ font-size: 16px; color: #eee; border-bottom: 1px solid #555; padding: 5px 10px; background-color: rgba(0,0,0,0.2); border-radius: 3px 3px 0 0; }
        .ui-close-button { position: absolute; top: 8px; right: 8px; background: #8b0000; color: white; border: 1px solid #400; border-radius: 3px; cursor: pointer; font-size: 12px; padding: 1px 6px; line-height: 1.2; font-weight: bold; transition: background-color 0.1s; }
        .ui-close-button:hover { background-color: #c00; }
        .ui-window-content { max-height: 70vh; overflow-y: auto; padding-right: 5px; /* Space for scrollbar */ } /* Prevent windows getting too tall */

        /* --- 物品栏 UI --- */
        #inventory-window { width: 356px; /* 9 * 40 + 4*8 + padding? */ }
        .inventory-grid, .crafting-grid, .chest-grid, .furnace-slots-container, .player-inventory-mirror { display: grid; grid-template-columns: repeat(9, 38px); /* Adjusted for 38px slots */ gap: 2px; margin-bottom: 8px; justify-content: center; /* Center grids if needed */ }
        .crafting-area { margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        .crafting-grid { grid-template-columns: repeat(3, 38px); display: inline-grid; vertical-align: middle; margin-right: 10px; gap: 2px; }
        .player-crafting-grid { grid-template-columns: repeat(2, 38px); }
        .crafting-arrow { display: inline-block; font-size: 24px; margin: 0 5px; vertical-align: middle; color: #ccc; }
        .crafting-output .slot { width: 38px; height: 38px; border: 2px solid #aaa; background-color: rgba(50,50,50,0.7); cursor: pointer; } /* Make output clickable */

        /* --- 熔炉 UI --- */
        #furnace-window { width: 200px; }
        .furnace-slots-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .furnace-io-fuel { display: flex; align-items: center; margin: 5px 0; justify-content: center; gap: 5px; }
        .furnace-progress-indicators { display: inline-block; margin: 0 10px; text-align: center; }
        .furnace-progress { width: 80px; height: 8px; background-color: #444; margin-bottom: 4px; border: 1px solid #222; border-radius: 2px; overflow: hidden; }
        .furnace-progress-bar { width: 0%; height: 100%; background-color: #ffa500; transition: width 0.1s linear; }
        .furnace-fuel-display { width: 14px; height: 14px; background-color: #444; position: relative; border: 1px solid #222; transform: rotate(180deg); /* Flames go up */ margin-top: 4px; display: inline-block; }
        .furnace-fuel-bar { position: absolute; bottom: 0; left: 0; width: 100%; background-color: #ff4500; /* OrangeRed */ height: 0%; transition: height 0.1s linear; }
        #furnace-window .slot { width: 38px; height: 38px; } /* Consistent slot size */

         /* --- 箱子 UI --- */
         #chest-window { width: 356px; }
         .chest-grid { grid-template-columns: repeat(9, 38px); gap: 2px; } /* 9xN chest */

         /* --- Player Inventory Mirror (Common style) --- */
         .player-inventory-mirror h4 { font-size: 11px; margin: 10px 0 5px 0; color: #aaa; text-align: center; font-weight: normal; }
         .player-main-inventory-mirror { /* Uses inventory-grid */ }
         .player-hotbar-mirror { /* Uses inventory-grid */ }

        /* --- 天空/日夜 (颜色驱动, DOM元素仅视觉辅助) --- */
        #sky { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        #sun, #moon { display: none; position: absolute; width: 50px; height: 50px; border-radius: 50%; background-size: cover; pointer-events: none; z-index: 1; }
        #sun { background-color: #FFD700; box-shadow: 0 0 25px #FFD700; }
        #moon { background-color: #E0E0E0; box-shadow: 0 0 15px #E0E0E0; }

        /* --- 游戏说明 --- */
        #instructions { position: fixed; /* Use fixed to overlay game */ top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(30, 30, 30, 0.9); padding: 15px 20px; border-radius: 5px; font-size: 12px; line-height: 1.4; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; pointer-events: all; display: none; /* 初始隐藏 */ border: 1px solid #555; z-index: 60; box-shadow: 0 0 20px rgba(0,0,0,0.7); }
        #instructions h3 { margin: 0 0 10px 0; font-size: 18px; color: #eee; border-bottom: 1px solid #555; padding-bottom: 5px; }
        #instructions h4 { margin: 12px 0 5px 0; font-size: 14px; color: #ddd; border-bottom: 1px dashed #444; padding-bottom: 2px; }
        #instructions p { margin: 8px 0; }
        #instructions ul { padding-left: 20px; margin: 8px 0; list-style: disc; }
        #instructions code { background: #444; padding: 2px 4px; border-radius: 3px; font-family: Consolas, Monaco, monospace; font-size: 11px; border: 1px solid #555; }
        #instructions .key { font-weight: bold; color: #ffcc66; } /* Highlight keys */
        #instructions strong { color: #aaffaa; } /* Highlight important terms */

        /* --- Block Break Indicator --- */
        /* Style handled by JS material */

        /* --- Held Item Floating UI --- */
        #held-item-ui { display: none; position: fixed; /* Use fixed to position relative to viewport */ width: 38px; height: 38px; border: 1px solid white; z-index: 100; pointer-events: none; background-color: rgba(50,50,50,0.8); background-size: 80%; background-repeat: no-repeat; background-position: center; image-rendering: pixelated; transform: translate(-50%, -50%); /* Center on cursor */ }
        #held-item-ui .item-count { /* Copied from .slot .item-count */ font-size: 10px; color: white; text-shadow: 1px 1px 1px black; padding: 0 2px; position: absolute; bottom: 1px; right: 1px; }

    </style>
</head>
<body>
    <!-- Sky Elements (Visual only) -->
    <div id="sky">
        <div id="sun"></div>
        <div id="moon"></div>
    </div>

    <!-- UI Root -->
    <div id="uiContainer">
        <!-- HUD -->
        <div id="crosshair"></div>
        <div id="infoPanel">
            XYZ: <span id="infoPos">0,0,0</span> Chunk: <span id="infoChunkKey">0,0</span><br>
            Vel: <span id="infoVel">0,0,0</span> Ground: <span id="infoGround">N</span><br>
            FPS: <span id="infoFPS">0</span> Mesh: <span id="infoMeshes">0</span> Ent: <span id="infoEntities">0</span><br>
            TickQ: <span id="infoTickQueue">L:0 P:0 B:0</span><br>
            Time: <span id="infoTime">00:00</span> Day: <span id="infoDay">0</span> Light: <span id="infoLight">S:15 B:0 P:0</span><br>
            Target: <span id="infoTarget">None</span><br>
            Biome: <span id="infoBiome">Plains</span>
        </div>
        <div id="hotbar"> <!-- Slots generated by JS --> </div>
        <!-- Center Screen Messages -->
        <div id="message"></div>
        <!-- Held Item UI (follows mouse when UI open) -->
        <div id="held-item-ui"><span class="item-count"></span></div>
    </div>

    <!-- UI Windows -->
    <div id="inventory-window" class="ui-window">
        <button class="ui-close-button" onclick="closeAllWindows()">X</button>
        <h2>物品栏 & 合成</h2>
        <div class="ui-window-content">
            <div class="crafting-area">
                 <div class="crafting-grid player-crafting-grid"> <!-- Slots generated by JS --> </div>
                 <span class="crafting-arrow">&rarr;</span>
                 <div class="crafting-output"> <div class="slot" data-slot-type="crafting_output"></div> </div>
            </div>
            <div class="player-inventory-mirror"><h4>物品栏</h4></div>
            <div class="inventory-grid player-main-inventory"> <!-- Slots generated by JS --> </div>
            <div class="inventory-grid player-hotbar"> <!-- Slots generated by JS --> </div>
        </div>
    </div>

    <div id="workbench-window" class="ui-window">
        <button class="ui-close-button" onclick="closeAllWindows()">X</button>
        <h2>工作台</h2>
        <div class="ui-window-content">
             <div class="crafting-area">
                <div class="crafting-grid workbench-grid"> <!-- Slots generated by JS --> </div>
                 <span class="crafting-arrow">&rarr;</span>
                 <div class="crafting-output"> <div class="slot" data-slot-type="crafting_output"></div> </div>
             </div>
             <div class="player-inventory-mirror"><h4>物品栏</h4></div>
             <div class="inventory-grid player-main-inventory-mirror"></div>
             <div class="inventory-grid player-hotbar-mirror"></div>
         </div>
    </div>

    <div id="furnace-window" class="ui-window">
        <button class="ui-close-button" onclick="closeAllWindows()">X</button>
        <h2>熔炉</h2>
         <div class="ui-window-content">
            <div class="furnace-slots-container">
                 <div class="slot furnace-input" data-slot-type="furnace_input"></div> <!-- Input -->
                 <div class="furnace-io-fuel">
                     <div class="slot furnace-fuel" data-slot-type="furnace_fuel"></div> <!-- Fuel -->
                     <div class="furnace-progress-indicators">
                         <div class="furnace-progress"><div class="furnace-progress-bar"></div></div>
                         <div class="furnace-fuel-display"><div class="furnace-fuel-bar"></div></div>
                     </div>
                     <div class="slot furnace-output" data-slot-type="furnace_output"></div> <!-- Output -->
                 </div>
            </div>
            <div class="player-inventory-mirror"><h4>物品栏</h4></div>
            <div class="inventory-grid player-main-inventory-mirror"></div>
            <div class="inventory-grid player-hotbar-mirror"></div>
        </div>
    </div>

     <div id="chest-window" class="ui-window">
        <button class="ui-close-button" onclick="closeAllWindows()">X</button>
        <h2 id="chest-window-title">箱子</h2> <!-- Title can be updated for double chests -->
         <div class="ui-window-content">
            <div class="chest-grid"> <!-- Slots generated by JS (e.g., 9x3 or 9x6) --> </div>
            <div class="player-inventory-mirror"><h4>物品栏</h4></div>
            <div class="inventory-grid player-main-inventory-mirror"></div>
            <div class="inventory-grid player-hotbar-mirror"></div>
        </div>
    </div>

    <!-- Game Instructions Window -->
    <div id="instructions" class="ui-window">
         <button class="ui-close-button" onclick="toggleInstructions(false)">X</button>
         <h3>究极方块世界 - 游戏说明 (v1.1)</h3>
         <p>欢迎来到这个史诗级 (且极其消耗资源) 的方块世界！这几乎包含了所有你能想到的特性，但请做好性能不佳的准备。</p>
         <h4>基本操作:</h4>
         <ul>
             <li><b>移动:</b> <code class="key">W</code>, <code class="key">A</code>, <code class="key">S</code>, <code class="key">D</code></li>
             <li><b>跳跃:</b> <code class="key">空格键</code> (在水中效果减弱)</li>
             <li><b>环顾:</b> 移动 <code class="key">鼠标</code> (需点击屏幕锁定)</li>
             <li><b>破坏方块:</b> 按住鼠标 <code class="key">左键</code> (会出现破坏进度，不同工具效率不同，会消耗耐久度)</li>
             <li><b>放置/交互:</b> 鼠标 <code class="key">右键</code> (放置手中物品，或与工作台/熔炉/箱子/拉杆/按钮交互)</li>
             <li><b>切换物品:</b> 数字键 <code class="key">1</code>-<code>9</code> 或 <code class="key">鼠标滚轮</code></li>
             <li><b>打开/关闭物品栏:</b> <code class="key">I</code> 键 (或 <code class="key">E</code>)</li>
             <li><b>打开/关闭说明:</b> <code class="key">E</code> 键 (当物品栏等窗口未打开时)</li>
             <li><b>关闭窗口/解锁鼠标:</b> <code class="key">Esc</code> 键</li>
             <li><b>丢弃物品:</b> <code class="key">Q</code> 键 (丢弃当前选中物品一个)</li>
             <!-- <li><b>丢弃整组:</b> <code>Ctrl</code>+<code>Q</code> (未完全实现)</li> -->
             <li><b>保存游戏:</b> <code class="key">F5</code> (覆盖保存到浏览器 localStorage)</li>
             <li><b>加载游戏:</b> <code class="key">F9</code> (从 localStorage 加载最后存档)</li>
             <li><b>切换火把:</b> <code class="key">T</code> (快速切换到物品栏中的火把)</li>
         </ul>
         <h4>核心系统详解:</h4>
         <ul>
             <li><strong>物品 & 工具:</strong> 物品有堆叠上限 (通常为 64)。工具 (镐、斧、锹) 和武器有<b>耐久度</b>，使用会消耗。工具可加速破坏特定方块，但需满足<b>挖掘等级</b>要求 (木 &rarr; 石 &rarr; 铁 &rarr; 钻石)。用错工具或等级不够会极大地减慢速度且无法获得掉落物。</li>
             <li><strong>合成:</strong>
                <ul>
                    <li><b>物品栏合成 (2x2):</b> 按 <code class="key">I</code> 打开物品栏，使用上方的 2x2 格子进行简单合成 (如木板、木棍、火把、工作台)。</li>
                    <li><b>工作台合成 (3x3):</b> 右键点击放置好的工作台打开 3x3 合成界面，可合成工具、武器、熔炉、箱子等更复杂的物品。</li>
                    <li>将材料按<b>正确的配方形状</b>摆放，成品会出现在右侧输出格，点击即可取出 (需消耗材料)。</li>
                </ul>
             </li>
             <li><strong>熔炉:</strong> 右键点击熔炉打开界面。将可烧炼物品 (如铁矿石、金矿石、沙子、圆石、原木) 放入<b>上方格子</b>，将燃料 (如煤炭、木头、木板、岩浆桶) 放入<b>下方格子</b>。熔炉会自动消耗燃料开始燃烧 (下方有火焰进度)，烧炼过程显示在中间进度条，成品会出现在<b>右侧格子</b>。</li>
             <li><strong>箱子:</strong> 提供 27 格额外存储空间。右键打开，可与物品栏进行物品交换。</li>
             <li><strong>光照:</strong> 分为<b>天空光</b> (受日夜影响) 和<b>方块光</b> (火把、岩浆、发光的红石火把、燃烧的熔炉)。光照等级为 0-15，直接影响方块亮度。黑暗处 (< level 7) 可能生成怪物 (怪物未实现)。</li>
             <li><strong>日夜循环 & 天空:</strong> 游戏内有 20 分钟的日夜循环。时间流逝会改变天空颜色、太阳/月亮位置 (视觉效果)、天空光亮度和环境光强度。夜晚会变得非常暗。</li>
             <li><strong>物理:</strong> 沙子、沙砾在下方无支撑时会变成<b>掉落的方块实体</b>下落，落地后变回方块或掉落物品。水和岩浆会尝试向下和水平流动 (水流较快，岩浆较慢且会发光)。破坏方块会生成<b>掉落物实体</b>，一段时间后或玩家靠近可拾取，5分钟后消失。</li>
             <li><strong>世界生成:</strong>
                <ul>
                    <li><b>地形 & 生物群系:</b> 基于噪声生成起伏的地形，并区分平原、沙漠、森林、山地、海洋等群系，影响地表、植被和地形特征。使用噪声进行生物群系间的平滑过渡。</li>
                    <li><b>洞穴 & 峡谷:</b> 通过 3D 噪声在地下生成洞穴网络，偶尔生成较深的峡谷。</li>
                    <li><b>矿石:</b> 煤、铁、金、钻石等矿石会以矿脉形式生成在不同深度的石头中。</li>
                    <li><b>结构 (基础):</b> 有小概率在平原生成简单的木屋结构，在地下生成基础的废弃矿井隧道片段 (由木板和栅栏构成，可能有蜘蛛网)。</li>
                </ul>
             </li>
             <li><strong>红石 (基础):</strong>
                <ul>
                    <li><b>能量源:</b> 红石火把 (亮)、拉杆 (开启)、按钮 (按下时)、红石块提供 15 级能量。</li>
                    <li><b>传导:</b> 红石线可以传导能量，每格衰减 1 级。红石线会自动连接相邻的红石元件 (视觉连接简化)。</li>
                    <li><b>反相器:</b> 红石火把插在被充能的方块侧面或下方时会熄灭，反之则点亮。</li>
                    <li><b>控制:</b> 拉杆可永久切换状态，按钮按下后短暂输出能量然后自动弹回。</li>
                    <li><b>注意:</b> 红石逻辑简化，可能缺少强/弱充能、点状连接、精确更新顺序等复杂特性。</li>
                </ul>
             </li>
             <li><strong>农业 (基础):</strong> 使用锄 (<code class="key">右键</code>) 可将草地/泥土变为耕地。耕地在靠近水源 (4格内，同高度或高一格) 时会变为湿润耕地 (有 Tick 检查)。在耕地上 <code class="key">右键</code> 使用小麦种子可种植小麦。小麦需要光照 (>9) 和时间 (随机 Tick) 生长 (7个阶段)，成熟后破坏可获得小麦和种子。</li>
         </ul>
         <h4>性能提示:</h4>
         <ul>
             <li>如果游戏变得卡顿，尝试在设置中 (未实现) 或通过修改代码降低视距 (<code class="key">RENDER_DISTANCE_CHUNKS</code>)。</li>
             <li>大量的红石更新、流体流动或掉落物可能导致性能下降。</li>
             <li>这是一个单文件实验，性能优化非常有限。关闭不必要的浏览器标签页可能会有帮助。</li>
         </ul>
         <p><b>免责声明:</b> 本程序仅为技术演示和编程挑战，与 Mojang Studios 的 Minecraft 无关。代码极其复杂且性能无法保证。</p>
         <p style="text-align: center; margin-top: 15px;">祝你在探索和创造中获得乐趣！</p>
     </div>

    <!-- Loading Screen -->
    <div id="loading">
        <div id="loading-text">启动究极方块世界引擎...</div>
        <div id="loading-subtext">这可能需要相当长的时间...</div>
        <div id="loading-progress"><div id="loading-progress-bar" style="width: 0%;"></div></div>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
    
// --- START OF CLEANED & INLINED simplex-noise.min.js ---
"use strict";
const t = .5 * (Math.sqrt(3) - 1), e = (3 - Math.sqrt(3)) / 6, o = 1 / 6, n = (Math.sqrt(5) - 1) / 4, r = (5 - Math.sqrt(5)) / 20, s = new Float32Array([1, 1, 0, -1, 1, 0, 1, -1, 0, -1, -1, 0, 1, 0, 1, -1, 0, 1, 1, 0, -1, -1, 0, -1, 0, 1, 1, 0, -1, 1, 0, 1, -1, 0, -1, -1]), i = new Float32Array([0, 1, 1, 1, 0, 1, 1, -1, 0, 1, -1, 1, 0, 1, -1, -1, 0, -1, 1, 1, 0, -1, 1, -1, 0, -1, -1, 1, 0, -1, -1, -1, 1, 0, 1, 1, 1, 0, 1, -1, 1, 0, -1, 1, 1, 0, -1, -1, -1, 0, 1, 1, -1, 0, 1, -1, -1, 0, -1, 1, -1, 0, -1, -1, 1, 1, 0, 1, 1, 1, 0, -1, 1, -1, 0, 1, 1, -1, 0, -1, -1, 1, 0, 1, -1, 1, 0, -1, -1, -1, 0, 1, -1, -1, 0, -1, 1, 1, 1, 0, 1, 1, -1, 0, 1, -1, 1, 0, 1, -1, -1, 0, -1, 1, 1, 0, -1, 1, -1, 0, -1, -1, 1, 0, -1, -1, -1, 0]);

window.SimplexNoise = class { // <--- 修改在这里
    constructor(t = Math.random) {
        const e = "function" == typeof t ? t : function(t) { let e = 0, o = 0, n = 0, r = 1; const s = function() { let t = 4022871197; return function(e) { e = e.toString(); for (let o = 0; o < e.length; o++) { t += e.charCodeAt(o); let n = .02519603282416938 * t; t = n >>> 0, n -= t, n *= t, t = n >>> 0, n -= t, t += 4294967296 * n } return 2.3283064365386963e-10 * (t >>> 0) } }(); return e = s(" "), o = s(" "), n = s(" "), e -= s(t), e < 0 && (e += 1), o -= s(t), o < 0 && (o += 1), n -= s(t), n < 0 && (n += 1), function() { const t = 2091639 * e + 2.3283064365386963e-10 * r; return e = o, o = n, n = t - (r = 0 | t) } }(t);
        this.p = function(t) { const e = new Uint8Array(256); for (let t = 0; t < 256; t++)e[t] = t; for (let o = 0; o < 255; o++) { const n = o + ~~(t() * (256 - o)), r = e[o]; e[o] = e[n], e[n] = r } return e }(e), this.perm = new Uint8Array(512), this.permMod12 = new Uint8Array(512);
        for (let t = 0; t < 512; t++)this.perm[t] = this.p[255 & t], this.permMod12[t] = this.perm[t] % 12
    }
    noise2D(o, n) { const r = this.permMod12, i = this.perm; let l = 0, c = 0, a = 0; const f = (o + n) * t, h = Math.floor(o + f), u = Math.floor(n + f), m = (h + u) * e, M = o - (h - m), p = n - (u - m); let d, g; M > p ? (d = 1, g = 0) : (d = 0, g = 1); const w = M - d + e, A = p - g + e, y = M - 1 + 2 * e, D = p - 1 + 2 * e, q = 255 & h, F = 255 & u; let v = .5 - M * M - p * p; if (v >= 0) { const t = 3 * r[q + i[F]]; v *= v, l = v * v * (s[t] * M + s[t + 1] * p) } let I = .5 - w * w - A * A; if (I >= 0) { const t = 3 * r[q + d + i[F + g]]; I *= I, c = I * I * (s[t] * w + s[t + 1] * A) } let U = .5 - y * y - D * D; if (U >= 0) { const t = 3 * r[q + 1 + i[F + 1]]; U *= U, a = U * U * (s[t] * y + s[t + 1] * D) } return 70 * (l + c + a) }
    noise3D(t, e, n) { const r = this.permMod12, i = this.perm; let l, c, a, f; const h = .3333333333333333 * (t + e + n), u = Math.floor(t + h), m = Math.floor(e + h), M = Math.floor(n + h), p = (u + m + M) * o, d = t - (u - p), g = e - (m - p), w = n - (M - p); let A, y, D, q, F, v; d >= g ? g >= w ? (A = 1, y = 0, D = 0, q = 1, F = 1, v = 0) : d >= w ? (A = 1, y = 0, D = 0, q = 1, F = 0, v = 1) : (A = 0, y = 0, D = 1, q = 1, F = 0, v = 1) : g < w ? (A = 0, y = 0, D = 1, q = 0, F = 1, v = 1) : d < w ? (A = 0, y = 1, D = 0, q = 0, F = 1, v = 1) : (A = 0, y = 1, D = 0, q = 1, F = 1, v = 0); const I = d - A + o, U = g - y + o, C = w - D + o, x = d - q + .3333333333333333, B = g - F + .3333333333333333, E = w - v + .3333333333333333, S = d - 1 + .5, b = g - 1 + .5, j = w - 1 + .5, k = 255 & u, z = 255 & m, G = 255 & M; let H = .6 - d * d - g * g - w * w; if (H < 0) l = 0; else { const t = 3 * r[k + i[z + i[G]]]; H *= H, l = H * H * (s[t] * d + s[t + 1] * g + s[t + 2] * w) } let J = .6 - I * I - U * U - C * C; if (J < 0) c = 0; else { const t = 3 * r[k + A + i[z + y + i[G + D]]]; J *= J, c = J * J * (s[t] * I + s[t + 1] * U + s[t + 2] * C) } let K = .6 - x * x - B * B - E * E; if (K < 0) a = 0; else { const t = 3 * r[k + q + i[z + F + i[G + v]]]; K *= K, a = K * K * (s[t] * x + s[t + 1] * B + s[t + 2] * E) } let L = .6 - S * S - b * b - j * j; if (L < 0) f = 0; else { const t = 3 * r[k + 1 + i[z + 1 + i[G + 1]]]; L *= L, f = L * L * (s[t] * S + s[t + 1] * b + s[t + 2] * j) } return 32 * (l + c + a + f) }
    noise4D(t, e, o, s) { const l = this.perm; let c, a, f, h, u; const m = (t + e + o + s) * n, M = Math.floor(t + m), p = Math.floor(e + m), d = Math.floor(o + m), g = Math.floor(s + m), w = (M + p + d + g) * r, A = t - (M - w), y = e - (p - w), D = o - (d - w), q = s - (g - w); let F = 0, v = 0, I = 0, U = 0; A > y ? F++ : v++, A > D ? F++ : I++, A > q ? F++ : U++, y > D ? v++ : I++, y > q ? v++ : U++, D > q ? I++ : U++; const C = F >= 3 ? 1 : 0, x = v >= 3 ? 1 : 0, B = I >= 3 ? 1 : 0, E = U >= 3 ? 1 : 0, S = F >= 2 ? 1 : 0, b = v >= 2 ? 1 : 0, j = I >= 2 ? 1 : 0, k = U >= 2 ? 1 : 0, z = F >= 1 ? 1 : 0, G = v >= 1 ? 1 : 0, H = I >= 1 ? 1 : 0, J = U >= 1 ? 1 : 0, K = A - C + r, L = y - x + r, N = D - B + r, O = q - E + r, P = A - S + 2 * r, Q = y - b + 2 * r, R = D - j + 2 * r, T = q - k + 2 * r, V = A - z + 3 * r, W = y - G + 3 * r, X = D - H + 3 * r, Y = q - J + 3 * r, Z = A - 1 + 4 * r, $ = y - 1 + 4 * r, _ = D - 1 + 4 * r, tt = q - 1 + 4 * r, et = 255 & M, ot = 255 & p, nt = 255 & d, rt = 255 & g; let st = .6 - A * A - y * y - D * D - q * q; if (st < 0) c = 0; else { const t = l[et + l[ot + l[nt + l[rt]]]] % 32 * 4; st *= st, c = st * st * (i[t] * A + i[t + 1] * y + i[t + 2] * D + i[t + 3] * q) } let it = .6 - K * K - L * L - N * N - O * O; if (it < 0) a = 0; else { const t = l[et + C + l[ot + x + l[nt + B + l[rt + E]]]] % 32 * 4; it *= it, a = it * it * (i[t] * K + i[t + 1] * L + i[t + 2] * N + i[t + 3] * O) } let lt = .6 - P * P - Q * Q - R * R - T * T; if (lt < 0) f = 0; else { const t = l[et + S + l[ot + b + l[nt + j + l[rt + k]]]] % 32 * 4; lt *= lt, f = lt * lt * (i[t] * P + i[t + 1] * Q + i[t + 2] * R + i[t + 3] * T) } let ct = .6 - V * V - W * W - X * X - Y * Y; if (ct < 0) h = 0; else { const t = l[et + z + l[ot + G + l[nt + H + l[rt + J]]]] % 32 * 4; ct *= ct, h = ct * ct * (i[t] * V + i[t + 1] * W + i[t + 2] * X + i[t + 3] * Y) } let at = .6 - Z * Z - $ * $ - _ * _ - tt * tt; if (at < 0) u = 0; else { const t = l[et + 1 + l[ot + 1 + l[nt + 1 + l[rt + 1]]]] % 32 * 4; at *= at, u = at * at * (i[t] * Z + i[t + 1] * $ + i[t + 2] * _ + i[t + 3] * tt) } return 27 * (c + a + f + h + u) }
};
// --- END OF CLEANED & INLINED simplex-noise.min.js ---

        // --- END OF INLINED simplex-noise.min.js ---
        </script>

    <script>
        // ======================================================================================== //
        // ==                                                                                    == //
        // ==           Minecraft 克隆 (单文件 - 究极巨石版 v1.6 - Final Order Fix)              == //
        // ==   (包含: 区块, 贪婪合并, 光照, 日夜, 物理, 实体, 物品系统, 合成,                 == //
        // ==    熔炉, 箱子, 红石基础, 丰富世界生成, 工具耐久/效率, 农业基础, 等等...)         == //
        // ==                                                                                    == //
        // ======================================================================================== //
        // ==   警告: 此文件代码量巨大 (>10000行)，结构混乱，性能低下。仅用于编程挑战。         == //
        // ==         强烈建议不要在实际项目中使用此结构！！！                                   == //
        // ======================================================================================== //

        'use strict';

        // --- 调试开关 ---
        const DEBUG = {
            init: true, core: false, collision: false, worldGen: false, saveLoad: true, // Less world gen logging by default
            sound: false, meshing: false, chunking: true, lighting: false, physics: false, // Less frequent system logging
            time: false, item: true, crafting: true, ui: true, entity: false, redstone: false,
            perf: false, farm: true, structure: true, // Log structure gen attempts
        };
        function debugLog(system, ...args) { if (DEBUG[system]) { console.log(`[${system}]`, ...args); } }
        // console.log("%cDebug Switches:", "color: cyan", DEBUG); // Log switches on startup

        // =========================================================================
        // ==                       核心常量与类型定义 (最优先!)                  ==
        // =========================================================================
        // --- 核心常量 ---
        const BLOCK_SIZE = 1;
        const CHUNK_SIZE = 16;
        const CHUNK_HEIGHT = 128;
        const WORLD_HEIGHT = CHUNK_HEIGHT;
        const RENDER_DISTANCE_CHUNKS = 6;
        const LOAD_DISTANCE_CHUNKS = RENDER_DISTANCE_CHUNKS + 2;
        const MAX_LIGHT_LEVEL = 15;
        const MAX_POWER_LEVEL = 15;
        const GRAVITY = -28.0;
        const TICK_RATE = 20;
        const ITEM_DESPAWN_TIME_TICKS = 5 * 60 * TICK_RATE;
        const PLAYER_REACH_DISTANCE = 5.0;
        const MAX_STACK_SIZE = 64;
        const WATER_SOURCE_META = 8; // Metadata value indicating water source block
        const LAVA_SOURCE_META = 8;  // Metadata value indicating lava source block
        const LIQUID_LEVEL_BITS = 3; // Number of bits used for liquid level (0-7)
        const LIQUID_SOURCE_BIT_INDEX = 3; // Which bit index indicates a source block

        // --- 枚举类型 (必须在使用它们的常量之前定义) ---
        // Block Types Enum
        const BLOCK_TYPES = {
            AIR: 0, GRASS: 1, DIRT: 2, STONE: 3, COBBLESTONE: 4, WOOD_PLANKS: 5,
            SAND: 6, GRAVEL: 7, LOG_OAK: 8, LEAVES_OAK: 9, GLASS: 10,
            WATER: 11, LAVA: 12, TORCH: 13, BEDROCK: 14, WORKBENCH: 15, FURNACE: 16, CHEST: 17,
            REDSTONE_WIRE: 18, REDSTONE_TORCH_OFF: 19, REDSTONE_TORCH_ON: 20, LEVER: 21,
            STONE_BUTTON: 22, REDSTONE_BLOCK: 23,
            FARMLAND_DRY: 24, FARMLAND_WET: 25, WHEAT_CROP: 26,
            COAL_ORE: 27, IRON_ORE: 28, GOLD_ORE: 29, DIAMOND_ORE: 30,
            RAIL: 31, POWERED_RAIL: 32, DETECTOR_RAIL: 33, ACTIVATOR_RAIL: 34,
            OAK_DOOR_BOTTOM: 35, OAK_DOOR_TOP: 36,
            LADDER: 37, SIGN_POST: 38, SIGN_WALL: 39,
            OAK_FENCE: 40,
            // ... More block IDs ...
        };
        // Item Types Enum
        const ITEM_TYPES = {
            ...BLOCK_TYPES, // Blocks can be items
            WOODEN_PICKAXE: 100, STONE_PICKAXE: 101, IRON_PICKAXE: 102, DIAMOND_PICKAXE: 103, GOLDEN_PICKAXE: 104,
            WOODEN_AXE: 105, STONE_AXE: 106, IRON_AXE: 107, DIAMOND_AXE: 108, GOLDEN_AXE: 109,
            WOODEN_SHOVEL: 110, STONE_SHOVEL: 111, IRON_SHOVEL: 112, DIAMOND_SHOVEL: 113, GOLDEN_SHOVEL: 114,
            WOODEN_SWORD: 115, STONE_SWORD: 116, IRON_SWORD: 117, DIAMOND_SWORD: 118, GOLDEN_SWORD: 119,
            WOODEN_HOE: 120, STONE_HOE: 121, IRON_HOE: 122, DIAMOND_HOE: 123, GOLDEN_HOE: 124,
            SHEARS: 125,
            STICK: 200, COAL: 201, IRON_INGOT: 202, GOLD_INGOT: 203, DIAMOND: 204,
            WHEAT: 205, BREAD: 206, SEEDS_WHEAT: 207,
            REDSTONE_DUST: 208,
            BUCKET: 209, WATER_BUCKET: 210, LAVA_BUCKET: 211,
            FLINT: 212, FLINT_AND_STEEL: 213,
            SIGN: 214, OAK_DOOR: 215,
            // ... More item IDs ...
        };
        // Tool Enums
        const MINING_LEVEL = { HAND: 0, WOOD: 1, STONE: 2, IRON: 3, DIAMOND: 4, GOLD: 1 };
        const TOOL_TYPE = { NONE: 'none', PICKAXE: 'pickaxe', AXE: 'axe', SHOVEL: 'shovel', SWORD: 'sword', HOE: 'hoe', SHEARS: 'shears' };

        // =========================================================================
        // ==            方块/物品属性与配方 (依赖上面的类型定义)                  ==
        // =========================================================================
        // Mining Info & Break Times (Defined earlier using BLOCK_TYPES)
        const BLOCK_MINING_INFO = {
            [BLOCK_TYPES.STONE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.WOOD },
            [BLOCK_TYPES.COBBLESTONE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.WOOD },
            [BLOCK_TYPES.BEDROCK]: { unbreakable: true },
            [BLOCK_TYPES.LOG_OAK]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.WOOD_PLANKS]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.DIRT]: { tool: TOOL_TYPE.SHOVEL, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.GRASS]: { tool: TOOL_TYPE.SHOVEL, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.SAND]: { tool: TOOL_TYPE.SHOVEL, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.GRAVEL]: { tool: TOOL_TYPE.SHOVEL, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.WORKBENCH]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.FURNACE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.WOOD },
            [BLOCK_TYPES.CHEST]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND },
            [BLOCK_TYPES.COAL_ORE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.WOOD },
            [BLOCK_TYPES.IRON_ORE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.STONE },
            [BLOCK_TYPES.GOLD_ORE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.IRON },
            [BLOCK_TYPES.DIAMOND_ORE]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.IRON },
            [BLOCK_TYPES.REDSTONE_BLOCK]: { tool: TOOL_TYPE.PICKAXE, level: MINING_LEVEL.WOOD },
             [BLOCK_TYPES.REDSTONE_WIRE]: { breakInstantly: true }, [BLOCK_TYPES.REDSTONE_TORCH_OFF]: { breakInstantly: true },
             [BLOCK_TYPES.REDSTONE_TORCH_ON]: { breakInstantly: true }, [BLOCK_TYPES.LEVER]: { breakInstantly: true },
             [BLOCK_TYPES.STONE_BUTTON]: { breakInstantly: true }, [BLOCK_TYPES.RAIL]: { breakInstantly: true },
             [BLOCK_TYPES.POWERED_RAIL]: { breakInstantly: true },[BLOCK_TYPES.DETECTOR_RAIL]: { breakInstantly: true },
             [BLOCK_TYPES.ACTIVATOR_RAIL]: { breakInstantly: true },
             [BLOCK_TYPES.LEAVES_OAK]: { tool: TOOL_TYPE.SHEARS, level: MINING_LEVEL.HAND, breakInstantlyWithTool: true, breakInstantly: false },
             [BLOCK_TYPES.GLASS]: { breakInstantly: true },
             [BLOCK_TYPES.WHEAT_CROP]: { breakInstantly: true }, [BLOCK_TYPES.LADDER]: { breakInstantly: true },
             [BLOCK_TYPES.SIGN_POST]: { breakInstantly: true }, [BLOCK_TYPES.SIGN_WALL]: { breakInstantly: true },
             [BLOCK_TYPES.OAK_DOOR_BOTTOM]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND }, [BLOCK_TYPES.OAK_DOOR_TOP]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND, breakInstantly: true },
             [BLOCK_TYPES.OAK_FENCE]: { tool: TOOL_TYPE.AXE, level: MINING_LEVEL.HAND },
        };
        const BASE_BREAK_TIME = {
             [BLOCK_TYPES.STONE]: 7.5, [BLOCK_TYPES.COBBLESTONE]: 7.5, [BLOCK_TYPES.DIRT]: 0.75,
             [BLOCK_TYPES.GRASS]: 0.9, [BLOCK_TYPES.SAND]: 0.75, [BLOCK_TYPES.GRAVEL]: 0.9,
             [BLOCK_TYPES.LOG_OAK]: 3.0, [BLOCK_TYPES.WOOD_PLANKS]: 2.25, [BLOCK_TYPES.LEAVES_OAK]: 0.3,
             [BLOCK_TYPES.GLASS]: 0.45, [BLOCK_TYPES.TORCH]: 0.05, [BLOCK_TYPES.WORKBENCH]: 2.25,
             [BLOCK_TYPES.FURNACE]: 5.25, [BLOCK_TYPES.CHEST]: 2.25, [BLOCK_TYPES.REDSTONE_BLOCK]: 7.5,
             [BLOCK_TYPES.COAL_ORE]: 4.5, [BLOCK_TYPES.IRON_ORE]: 4.5, [BLOCK_TYPES.GOLD_ORE]: 4.5, [BLOCK_TYPES.DIAMOND_ORE]: 4.5,
             [BLOCK_TYPES.REDSTONE_WIRE]: 0.05, [BLOCK_TYPES.REDSTONE_TORCH_OFF]: 0.05, [BLOCK_TYPES.REDSTONE_TORCH_ON]: 0.05,
             [BLOCK_TYPES.LEVER]: 0.05, [BLOCK_TYPES.STONE_BUTTON]: 0.05, [BLOCK_TYPES.RAIL]: 0.05, [BLOCK_TYPES.POWERED_RAIL]: 0.05,
             [BLOCK_TYPES.DETECTOR_RAIL]: 0.05, [BLOCK_TYPES.ACTIVATOR_RAIL]: 0.05,
             [BLOCK_TYPES.WHEAT_CROP]: 0.05, [BLOCK_TYPES.FARMLAND_DRY]: 0.9, [BLOCK_TYPES.FARMLAND_WET]: 0.9, [BLOCK_TYPES.LADDER]: 0.05,
             [BLOCK_TYPES.SIGN_POST]: 1.5, [BLOCK_TYPES.SIGN_WALL]: 1.5, [BLOCK_TYPES.OAK_DOOR_BOTTOM]: 2.25, [BLOCK_TYPES.OAK_DOOR_TOP]: 0.05,
             [BLOCK_TYPES.OAK_FENCE]: 2.25,
             default: 1.5
         };
         // Tool efficiency MULTIPLIER (Higher is better)
         const TOOL_EFFICIENCY_MULTIPLIER = {
             WOOD: 2.0, STONE: 4.0, IRON: 6.0, DIAMOND: 8.0, GOLD: 12.0,
         };
         // Penalty DIVISOR (Higher makes it slower)
         const TOOL_INCORRECT_LEVEL_PENALTY = 5.0;
         const TOOL_INCORRECT_TYPE_PENALTY = 5.0; // Make penalties similar

        // Block Properties Dictionary
        const BLOCK_PROPERTIES = { /* ... (Massive expanded list, uses BLOCK_TYPES) ... */
            [BLOCK_TYPES.AIR]: { name: '空气', transparent: true, solid: false, lightPasses: true, powerPasses: true, lightEmission: 0 },
            [BLOCK_TYPES.GRASS]: { name: '草方块', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: { top: 'grass_top', side: 'grass_side', bottom: 'dirt' }, drop: BLOCK_TYPES.DIRT, flammable: true },
            [BLOCK_TYPES.DIRT]: { name: '泥土', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'dirt', drop: BLOCK_TYPES.DIRT, flammable: true },
            [BLOCK_TYPES.STONE]: { name: '石头', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'stone', drop: BLOCK_TYPES.COBBLESTONE },
            [BLOCK_TYPES.COBBLESTONE]: { name: '圆石', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'cobblestone', drop: BLOCK_TYPES.COBBLESTONE },
            [BLOCK_TYPES.WOOD_PLANKS]: { name: '木板', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'wood_planks_oak', drop: BLOCK_TYPES.WOOD_PLANKS, flammable: true, fuelTime: 300 },
            [BLOCK_TYPES.SAND]: { name: '沙子', transparent: false, solid: true, lightPasses: false, powerPasses: false, hasGravity: true, textures: 'sand', drop: BLOCK_TYPES.SAND },
            [BLOCK_TYPES.GRAVEL]: { name: '沙砾', transparent: false, solid: true, lightPasses: false, powerPasses: false, hasGravity: true, textures: 'gravel', drop: ITEM_TYPES.FLINT, dropChance: 0.1, fallbackDrop: BLOCK_TYPES.GRAVEL },
            [BLOCK_TYPES.LOG_OAK]: { name: '橡木原木', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: { top: 'log_oak_top', side: 'log_oak_side', bottom: 'log_oak_top' }, drop: BLOCK_TYPES.LOG_OAK, flammable: true, fuelTime: 300 },
            [BLOCK_TYPES.LEAVES_OAK]: { name: '橡树叶', transparent: true, solid: true, lightPasses: true, powerPasses: true, textures: 'leaves_oak', drop: null, flammable: true, needsTick: true, shearDrop: BLOCK_TYPES.LEAVES_OAK },
            [BLOCK_TYPES.GLASS]: { name: '玻璃', transparent: true, solid: true, lightPasses: true, powerPasses: true, textures: 'glass', drop: null },
            [BLOCK_TYPES.WATER]: { name: '水', transparent: true, solid: false, lightPasses: true, powerPasses: true, isLiquid: true, flowSpeed: 1, textures: 'water_still', metadataBits: 4, flowDecay: 1 },
            [BLOCK_TYPES.LAVA]: { name: '岩浆', transparent: false, solid: false, lightPasses: false, powerPasses: true, isLiquid: true, flowSpeed: 3, textures: 'lava_still', lightEmission: 15, damage: 4, metadataBits: 4, flowDecay: 2, flammable: true },
            [BLOCK_TYPES.TORCH]: { name: '火把', transparent: true, solid: false, lightPasses: true, powerPasses: true, textures: 'torch_on', lightEmission: 14, drop: BLOCK_TYPES.TORCH, flammable: true, hasModel: 'torch', attachmentRule: ['onWall', 'onFloor'], metadataBits: 3 },
            [BLOCK_TYPES.BEDROCK]: { name: '基岩', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'bedrock', unbreakable: true, drop: null },
            [BLOCK_TYPES.WORKBENCH]: { name: '工作台', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: {top: 'crafting_table_top', side: 'crafting_table_side', front: 'crafting_table_front', bottom: 'wood_planks_oak'}, drop: BLOCK_TYPES.WORKBENCH, hasGui: 'workbench', flammable: true, fuelTime: 300 },
            [BLOCK_TYPES.FURNACE]: { name: '熔炉', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: {top: 'furnace_top', side: 'furnace_side', front: 'furnace_front_off', bottom: 'furnace_top'}, activeTextureFront: 'furnace_front_on', drop: BLOCK_TYPES.FURNACE, hasGui: 'furnace', stateful: true, metadataBits: 3, needsTick: true },
            [BLOCK_TYPES.CHEST]: { name: '箱子', transparent: false, solid: true, lightPasses: false, powerPasses: false, textures: 'chest_front?', drop: BLOCK_TYPES.CHEST, hasGui: 'chest', stateful: true, flammable: true, hasModel: 'chest' },

            // Redstone
            [BLOCK_TYPES.REDSTONE_WIRE]: { name: '红石线', transparent: true, solid: false, lightPasses: true, powerPasses: true, isConductive: true, textures: 'redstone_dust_dot', drop: ITEM_TYPES.REDSTONE_DUST, metadataBits: 4, hasModel: 'redstone_wire' },
            [BLOCK_TYPES.REDSTONE_TORCH_OFF]: { name: '红石火把 (灭)', transparent: true, solid: false, lightPasses: true, powerPasses: true, textures: 'redstone_torch_off', drop: ITEM_TYPES.REDSTONE_DUST, isPowerSource: false, stateful: true, needsTick: true, hasModel: 'torch', attachmentRule: ['onWall', 'onFloor'], metadataBits: 3 },
            [BLOCK_TYPES.REDSTONE_TORCH_ON]: { name: '红石火把 (亮)', transparent: true, solid: false, lightPasses: true, powerPasses: true, textures: 'redstone_torch_on', drop: ITEM_TYPES.REDSTONE_DUST, lightEmission: 7, isPowerSource: true, stateful: true, needsTick: true, hasModel: 'torch', attachmentRule: ['onWall', 'onFloor'], metadataBits: 3 },
            [BLOCK_TYPES.LEVER]: { name: '拉杆', transparent: true, solid: false, lightPasses: true, powerPasses: true, textures: 'lever', drop: BLOCK_TYPES.LEVER, isPowerSource: true, stateful: true, metadataBits: 4, hasModel: 'lever', attachmentRule: ['onWall', 'onFloor', 'onCeiling'] },
            [BLOCK_TYPES.STONE_BUTTON]: { name: '按钮', transparent: true, solid: false, lightPasses: true, powerPasses: true, textures: 'stone', drop: BLOCK_TYPES.STONE_BUTTON, isPowerSource: true, stateful: true, metadataBits: 4, needsTick: true, tickDelay: 20, hasModel: 'button', attachmentRule: ['onWall', 'onFloor', 'onCeiling'] },
            [BLOCK_TYPES.REDSTONE_BLOCK]: { name: '红石块', transparent: false, solid: true, lightPasses: false, powerPasses: false, isPowerSource: true, powerLevel: 15, textures: 'redstone_block', drop: BLOCK_TYPES.REDSTONE_BLOCK },

             // Farming
             [BLOCK_TYPES.FARMLAND_DRY]: { name: '耕地', transparent: false, solid: true, lightPasses: false, textures: { top: 'farmland_dry', side: 'dirt', bottom: 'dirt'}, drop: BLOCK_TYPES.DIRT, needsTick: true },
             [BLOCK_TYPES.FARMLAND_WET]: { name: '湿润耕地', transparent: false, solid: true, lightPasses: false, textures: { top: 'farmland_wet', side: 'dirt', bottom: 'dirt'}, drop: BLOCK_TYPES.DIRT },
             [BLOCK_TYPES.WHEAT_CROP]: { name: '小麦作物', transparent: true, solid: false, lightPasses: true, textures: 'wheat_stage_0', metadataBits: 3, needsTick: true, drop: ITEM_TYPES.SEEDS_WHEAT, matureDrop: ITEM_TYPES.WHEAT, hasModel: 'crop' },

             // Ores
             [BLOCK_TYPES.COAL_ORE]: { name: '煤矿石', transparent: false, solid: true, lightPasses: false, textures: 'coal_ore', drop: ITEM_TYPES.COAL },
             [BLOCK_TYPES.IRON_ORE]: { name: '铁矿石', transparent: false, solid: true, lightPasses: false, textures: 'iron_ore', drop: BLOCK_TYPES.IRON_ORE },
             [BLOCK_TYPES.GOLD_ORE]: { name: '金矿石', transparent: false, solid: true, lightPasses: false, textures: 'gold_ore', drop: BLOCK_TYPES.GOLD_ORE },
             [BLOCK_TYPES.DIAMOND_ORE]: { name: '钻石矿石', transparent: false, solid: true, lightPasses: false, textures: 'diamond_ore', drop: ITEM_TYPES.DIAMOND },

             // Rails
             [BLOCK_TYPES.RAIL]: { name: '铁轨', transparent: true, solid: false, lightPasses: true, textures: 'rail_normal', drop: BLOCK_TYPES.RAIL, hasModel: 'rail', metadataBits: 4 },
             [BLOCK_TYPES.POWERED_RAIL]: { name: '充能铁轨', transparent: true, solid: false, lightPasses: true, textures: 'rail_golden', drop: BLOCK_TYPES.POWERED_RAIL, hasModel: 'rail', metadataBits: 4 },
             [BLOCK_TYPES.DETECTOR_RAIL]: { name: '探测铁轨', transparent: true, solid: false, lightPasses: true, textures: 'rail_detector', drop: BLOCK_TYPES.DETECTOR_RAIL, hasModel: 'rail', metadataBits: 4, stateful: true },
             [BLOCK_TYPES.ACTIVATOR_RAIL]: { name: '激活铁轨', transparent: true, solid: false, lightPasses: true, textures: 'rail_activator', drop: BLOCK_TYPES.ACTIVATOR_RAIL, hasModel: 'rail', metadataBits: 4 },

            // Doors
             [BLOCK_TYPES.OAK_DOOR_BOTTOM]: { name: '橡木门', transparent: true, solid: true, lightPasses: true, textures: 'door_oak_lower', drop: ITEM_TYPES.OAK_DOOR, metadataBits: 4, hasModel: 'door', needsNeighborUpdate: true },
             [BLOCK_TYPES.OAK_DOOR_TOP]: { name: '橡木门', transparent: true, solid: true, lightPasses: true, textures: 'door_oak_upper', drop: null, metadataBits: 1, hasModel: 'door' },

             [BLOCK_TYPES.LADDER]: { name: '梯子', transparent: true, solid: false, lightPasses: true, textures: 'ladder', drop: BLOCK_TYPES.LADDER, hasModel: 'ladder', attachmentRule: ['onWall'], metadataBits: 3 },
             [BLOCK_TYPES.SIGN_POST]: { name: '告示牌', transparent: true, solid: false, lightPasses: true, textures: 'wood_planks_oak', drop: ITEM_TYPES.SIGN, hasModel: 'sign_post', stateful: true, metadataBits: 4 },
             [BLOCK_TYPES.SIGN_WALL]: { name: '告示牌', transparent: true, solid: false, lightPasses: true, textures: 'wood_planks_oak', drop: ITEM_TYPES.SIGN, hasModel: 'sign_wall', stateful: true, attachmentRule: ['onWall'], metadataBits: 3 },

             [BLOCK_TYPES.OAK_FENCE]: { name: '橡木栅栏', transparent: true, solid: true, lightPasses: true, textures: 'wood_planks_oak', drop: BLOCK_TYPES.OAK_FENCE, hasModel: 'fence', flammable: true, fuelTime: 300 },
        };
        // Item Properties Dictionary
        const ITEM_PROPERTIES = { /* ... (Massive expanded list, uses ITEM_TYPES) ... */
             [ITEM_TYPES.STICK]: { name: '木棍', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.COAL]: { name: '煤炭', stackSize: MAX_STACK_SIZE, fuelTime: 1600 },
             [ITEM_TYPES.IRON_INGOT]: { name: '铁锭', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.GOLD_INGOT]: { name: '金锭', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.DIAMOND]: { name: '钻石', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.WHEAT]: { name: '小麦', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.BREAD]: { name: '面包', stackSize: MAX_STACK_SIZE, foodValue: 5 },
             [ITEM_TYPES.SEEDS_WHEAT]: { name: '小麦种子', stackSize: MAX_STACK_SIZE, placeAs: BLOCK_TYPES.WHEAT_CROP },
             [ITEM_TYPES.REDSTONE_DUST]: { name: '红石粉', stackSize: MAX_STACK_SIZE, placeAs: BLOCK_TYPES.REDSTONE_WIRE },
             [ITEM_TYPES.BUCKET]: { name: '桶', stackSize: 1 },
             [ITEM_TYPES.WATER_BUCKET]: { name: '水桶', stackSize: 1, placeAs: BLOCK_TYPES.WATER, isBucket: true, liquid: BLOCK_TYPES.WATER, emptyBucket: ITEM_TYPES.BUCKET },
             [ITEM_TYPES.LAVA_BUCKET]: { name: '岩浆桶', stackSize: 1, placeAs: BLOCK_TYPES.LAVA, isBucket: true, liquid: BLOCK_TYPES.LAVA, emptyBucket: ITEM_TYPES.BUCKET, fuelTime: 20000 },
             [ITEM_TYPES.FLINT]: { name: '燧石', stackSize: MAX_STACK_SIZE },
             [ITEM_TYPES.FLINT_AND_STEEL]: { name: '打火石', stackSize: 1, durability: 65, useAction: 'ignite' },
             [ITEM_TYPES.SIGN]: { name: '告示牌', stackSize: 16, placeAs: BLOCK_TYPES.SIGN_POST },
             [ITEM_TYPES.OAK_DOOR]: { name: '橡木门', stackSize: 64, placeAs: BLOCK_TYPES.OAK_DOOR_BOTTOM },
             [ITEM_TYPES.SHEARS]: { name: '剪刀', stackSize: 1, durability: 238, toolType: TOOL_TYPE.SHEARS },

            // Tools
             [ITEM_TYPES.WOODEN_PICKAXE]: { name: '木镐', stackSize: 1, toolType: TOOL_TYPE.PICKAXE, miningLevel: MINING_LEVEL.WOOD, durability: 60, damage: 2, efficiency: TOOL_EFFICIENCY_MULTIPLIER.WOOD },
             [ITEM_TYPES.STONE_PICKAXE]: { name: '石镐', stackSize: 1, toolType: TOOL_TYPE.PICKAXE, miningLevel: MINING_LEVEL.STONE, durability: 132, damage: 3, efficiency: TOOL_EFFICIENCY_MULTIPLIER.STONE },
             [ITEM_TYPES.IRON_PICKAXE]: { name: '铁镐', stackSize: 1, toolType: TOOL_TYPE.PICKAXE, miningLevel: MINING_LEVEL.IRON, durability: 251, damage: 4, efficiency: TOOL_EFFICIENCY_MULTIPLIER.IRON },
             [ITEM_TYPES.DIAMOND_PICKAXE]: { name: '钻石镐', stackSize: 1, toolType: TOOL_TYPE.PICKAXE, miningLevel: MINING_LEVEL.DIAMOND, durability: 1562, damage: 5, efficiency: TOOL_EFFICIENCY_MULTIPLIER.DIAMOND },
             [ITEM_TYPES.GOLDEN_PICKAXE]: { name: '金镐', stackSize: 1, toolType: TOOL_TYPE.PICKAXE, miningLevel: MINING_LEVEL.WOOD, durability: 33, damage: 2, efficiency: TOOL_EFFICIENCY_MULTIPLIER.GOLD },
             [ITEM_TYPES.WOODEN_AXE]: { name: '木斧', stackSize: 1, toolType: TOOL_TYPE.AXE, miningLevel: MINING_LEVEL.WOOD, durability: 60, damage: 4, efficiency: TOOL_EFFICIENCY_MULTIPLIER.WOOD },
             [ITEM_TYPES.STONE_AXE]: { name: '石斧', stackSize: 1, toolType: TOOL_TYPE.AXE, miningLevel: MINING_LEVEL.STONE, durability: 132, damage: 5, efficiency: TOOL_EFFICIENCY_MULTIPLIER.STONE },
             [ITEM_TYPES.IRON_AXE]: { name: '铁斧', stackSize: 1, toolType: TOOL_TYPE.AXE, miningLevel: MINING_LEVEL.IRON, durability: 251, damage: 6, efficiency: TOOL_EFFICIENCY_MULTIPLIER.IRON },
             [ITEM_TYPES.DIAMOND_AXE]: { name: '钻石斧', stackSize: 1, toolType: TOOL_TYPE.AXE, miningLevel: MINING_LEVEL.DIAMOND, durability: 1562, damage: 7, efficiency: TOOL_EFFICIENCY_MULTIPLIER.DIAMOND },
             [ITEM_TYPES.GOLDEN_AXE]: { name: '金斧', stackSize: 1, toolType: TOOL_TYPE.AXE, miningLevel: MINING_LEVEL.WOOD, durability: 33, damage: 4, efficiency: TOOL_EFFICIENCY_MULTIPLIER.GOLD },
             [ITEM_TYPES.WOODEN_SHOVEL]: { name: '木锹', stackSize: 1, toolType: TOOL_TYPE.SHOVEL, miningLevel: MINING_LEVEL.WOOD, durability: 60, damage: 1, efficiency: TOOL_EFFICIENCY_MULTIPLIER.WOOD },
             [ITEM_TYPES.STONE_SHOVEL]: { name: '石锹', stackSize: 1, toolType: TOOL_TYPE.SHOVEL, miningLevel: MINING_LEVEL.STONE, durability: 132, damage: 2, efficiency: TOOL_EFFICIENCY_MULTIPLIER.STONE },
             [ITEM_TYPES.IRON_SHOVEL]: { name: '铁锹', stackSize: 1, toolType: TOOL_TYPE.SHOVEL, miningLevel: MINING_LEVEL.IRON, durability: 251, damage: 3, efficiency: TOOL_EFFICIENCY_MULTIPLIER.IRON },
             [ITEM_TYPES.DIAMOND_SHOVEL]: { name: '钻石锹', stackSize: 1, toolType: TOOL_TYPE.SHOVEL, miningLevel: MINING_LEVEL.DIAMOND, durability: 1562, damage: 4, efficiency: TOOL_EFFICIENCY_MULTIPLIER.DIAMOND },
             [ITEM_TYPES.GOLDEN_SHOVEL]: { name: '金锹', stackSize: 1, toolType: TOOL_TYPE.SHOVEL, miningLevel: MINING_LEVEL.WOOD, durability: 33, damage: 1, efficiency: TOOL_EFFICIENCY_MULTIPLIER.GOLD },
             [ITEM_TYPES.WOODEN_SWORD]: { name: '木剑', stackSize: 1, toolType: TOOL_TYPE.SWORD, durability: 60, damage: 4 },
             [ITEM_TYPES.STONE_SWORD]: { name: '石剑', stackSize: 1, toolType: TOOL_TYPE.SWORD, durability: 132, damage: 5 },
             [ITEM_TYPES.IRON_SWORD]: { name: '铁剑', stackSize: 1, toolType: TOOL_TYPE.SWORD, durability: 251, damage: 6 },
             [ITEM_TYPES.DIAMOND_SWORD]: { name: '钻石剑', stackSize: 1, toolType: TOOL_TYPE.SWORD, durability: 1562, damage: 7 },
             [ITEM_TYPES.GOLDEN_SWORD]: { name: '金剑', stackSize: 1, toolType: TOOL_TYPE.SWORD, durability: 33, damage: 4 },
             [ITEM_TYPES.WOODEN_HOE]: { name: '木锄', stackSize: 1, toolType: TOOL_TYPE.HOE, durability: 60, damage: 1 },
             [ITEM_TYPES.STONE_HOE]: { name: '石锄', stackSize: 1, toolType: TOOL_TYPE.HOE, durability: 132, damage: 1 },
             [ITEM_TYPES.IRON_HOE]: { name: '铁锄', stackSize: 1, toolType: TOOL_TYPE.HOE, durability: 251, damage: 1 },
             [ITEM_TYPES.DIAMOND_HOE]: { name: '钻石锄', stackSize: 1, toolType: TOOL_TYPE.HOE, durability: 1562, damage: 1 },
             [ITEM_TYPES.GOLDEN_HOE]: { name: '金锄', stackSize: 1, toolType: TOOL_TYPE.HOE, durability: 33, damage: 1 },
         };
        // --- Crafting Recipes (ONLY ONE DEFINITION) ---
        const RECIPES = [
            // 2x2 Examples
             { output: { id: ITEM_TYPES.WOOD_PLANKS, count: 4 }, shape: ["L"], ingredients: { 'L': ITEM_TYPES.LOG_OAK } },
             { output: { id: ITEM_TYPES.STICK, count: 4 }, shape: ["P", "P"], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS } },
             { output: { id: ITEM_TYPES.WORKBENCH, count: 1 }, shape: ["PP", "PP"], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS } },
             { output: { id: ITEM_TYPES.TORCH, count: 4 }, shape: ["C", "S"], ingredients: { 'C': ITEM_TYPES.COAL, 'S': ITEM_TYPES.STICK } },
             // 3x3 Examples
             { output: { id: ITEM_TYPES.WOODEN_PICKAXE, count: 1 }, shape: ["PPP", " S ", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.STONE_PICKAXE, count: 1 }, shape: ["CCC", " S ", " S "], ingredients: { 'C': ITEM_TYPES.COBBLESTONE, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.IRON_PICKAXE, count: 1 }, shape: ["III", " S ", " S "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.WOODEN_AXE, count: 1 }, shape: ["PP ", "PS ", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.STONE_AXE, count: 1 }, shape: ["CC ", "CS ", " S "], ingredients: { 'C': ITEM_TYPES.COBBLESTONE, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.WOODEN_SHOVEL, count: 1 }, shape: [" P ", " S ", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.STONE_SHOVEL, count: 1 }, shape: [" C ", " S ", " S "], ingredients: { 'C': ITEM_TYPES.COBBLESTONE, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.WOODEN_SWORD, count: 1 }, shape: [" P ", " P ", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.STONE_SWORD, count: 1 }, shape: [" C ", " C ", " S "], ingredients: { 'C': ITEM_TYPES.COBBLESTONE, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.WOODEN_HOE, count: 1 }, shape: ["PP ", " S ", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.STONE_HOE, count: 1 }, shape: ["CC ", " S ", " S "], ingredients: { 'C': ITEM_TYPES.COBBLESTONE, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.FURNACE, count: 1 }, shape: ["CCC", "C C", "CCC"], ingredients: { 'C': ITEM_TYPES.COBBLESTONE }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.CHEST, count: 1 }, shape: ["PPP", "P P", "PPP"], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.BUCKET, count: 1 }, shape: ["I I", " I "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.BREAD, count: 1 }, shape: ["WWW"], ingredients: { 'W': ITEM_TYPES.WHEAT }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.REDSTONE_BLOCK, count: 1 }, shape: ["RRR", "RRR", "RRR"], ingredients: { 'R': ITEM_TYPES.REDSTONE_DUST }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.OAK_FENCE, count: 3 }, shape: ["PSP", "PSP"], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.SHEARS, count: 1 }, shape: [" I", "I "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.SIGN, count: 3 }, shape: ["PPP", "PPP", " S "], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.LADDER, count: 3 }, shape: ["S S", "SSS", "S S"], ingredients: { 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.RAIL, count: 16 }, shape: ["I I", "ISI", "I I"], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.OAK_DOOR, count: 3 }, shape: ["PP", "PP", "PP"], ingredients: { 'P': ITEM_TYPES.WOOD_PLANKS }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.FLINT_AND_STEEL, count: 1 }, shape: ["I ", " F"], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'F': ITEM_TYPES.FLINT }, requiresWorkbench: false }, // 2x2 Flint and steel
             // Iron/Diamond/Gold Tools...
             { output: { id: ITEM_TYPES.IRON_AXE, count: 1 }, shape: ["II ", "IS ", " S "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.IRON_SHOVEL, count: 1 }, shape: [" I ", " S ", " S "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.IRON_SWORD, count: 1 }, shape: [" I ", " I ", " S "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.IRON_HOE, count: 1 }, shape: ["II ", " S ", " S "], ingredients: { 'I': ITEM_TYPES.IRON_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.DIAMOND_PICKAXE, count: 1 }, shape: ["DDD", " S ", " S "], ingredients: { 'D': ITEM_TYPES.DIAMOND, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.DIAMOND_AXE, count: 1 }, shape: ["DD ", "DS ", " S "], ingredients: { 'D': ITEM_TYPES.DIAMOND, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.DIAMOND_SHOVEL, count: 1 }, shape: [" D ", " S ", " S "], ingredients: { 'D': ITEM_TYPES.DIAMOND, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.DIAMOND_SWORD, count: 1 }, shape: [" D ", " D ", " S "], ingredients: { 'D': ITEM_TYPES.DIAMOND, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.DIAMOND_HOE, count: 1 }, shape: ["DD ", " S ", " S "], ingredients: { 'D': ITEM_TYPES.DIAMOND, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             // Gold...
             { output: { id: ITEM_TYPES.GOLDEN_PICKAXE, count: 1 }, shape: ["GGG", " S ", " S "], ingredients: { 'G': ITEM_TYPES.GOLD_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.GOLDEN_AXE, count: 1 }, shape: ["GG ", "GS ", " S "], ingredients: { 'G': ITEM_TYPES.GOLD_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.GOLDEN_SHOVEL, count: 1 }, shape: [" G ", " S ", " S "], ingredients: { 'G': ITEM_TYPES.GOLD_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.GOLDEN_SWORD, count: 1 }, shape: [" G ", " G ", " S "], ingredients: { 'G': ITEM_TYPES.GOLD_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
             { output: { id: ITEM_TYPES.GOLDEN_HOE, count: 1 }, shape: ["GG ", " S ", " S "], ingredients: { 'G': ITEM_TYPES.GOLD_INGOT, 'S': ITEM_TYPES.STICK }, requiresWorkbench: true },
        ];
        // --- Smelting Recipes & Fuel ---
        const SMELTING_RECIPES = {
             [BLOCK_TYPES.IRON_ORE]: { outputId: ITEM_TYPES.IRON_INGOT, cookTime: 200 },
             [BLOCK_TYPES.GOLD_ORE]: { outputId: ITEM_TYPES.GOLD_INGOT, cookTime: 200 },
             [BLOCK_TYPES.SAND]: { outputId: BLOCK_TYPES.GLASS, cookTime: 100 },
             [BLOCK_TYPES.COBBLESTONE]: { outputId: BLOCK_TYPES.STONE, cookTime: 100 },
             [BLOCK_TYPES.LOG_OAK]: { outputId: ITEM_TYPES.COAL, cookTime: 150 }, // Charcoal
        };
        const FUEL_SOURCES = {
             [ITEM_TYPES.COAL]: 1600, [BLOCK_TYPES.LOG_OAK]: 300, [BLOCK_TYPES.WOOD_PLANKS]: 300,
             [ITEM_TYPES.STICK]: 100, [ITEM_TYPES.LAVA_BUCKET]: 20000, [BLOCK_TYPES.WORKBENCH]: 300,
             [BLOCK_TYPES.OAK_FENCE]: 300,
        };
        function getItemProperty(itemId, propName) { /* ... */ }


        // =========================================================================
        // ==                           全局变量 (Final)                           ==
        // =========================================================================
        let scene, camera, renderer, ambientLight, directionalLight;
        const RENDER_DISTANCE_UNITS = RENDER_DISTANCE_CHUNKS * CHUNK_SIZE * 1.1;
        let isPaused = true, gameInitialized = false, isWindowOpen = false;
        const clock = new THREE.Clock();
        let fpsCounter = { frames: 0, lastTime: 0, value: 0, startTime: 0 };
        let gameTime = { totalTicks: 0, timeOfDay: 6000, day: 0 };
        const TICKS_PER_DAY = 24000;
        let lastTickTime = 0;
        const tickInterval = 1000 / TICK_RATE;
        const world = { chunks: {}, dirtyChunks: new Set(), lightQueue: [], skyLightQueue: [], powerQueue: new Set(), blocksToTick: new Map(), entities: [], tileEntities: {}, loadingProgress: { total: 0, loaded: 0, message: "启动中...", subtext: "" }};
        const player = { height: 1.75, halfWidth: 0.3, moveSpeed: 5.5, jumpVelocity: 9.0, mouseSensitivity: 0.002, reachDistance: PLAYER_REACH_DISTANCE, velocity: new THREE.Vector3(), direction: new THREE.Vector3(), onGround: false, controlsLocked: false, headInWater: false, input: { forward: false, backward: false, left: false, right: false, jump: false }, inventory: Array(36).fill(null), selectedSlot: 0, craftingGrid: Array(5).fill(null), heldItem: null, positionUpdateNeeded: true, currentChunkKey: "0,0", breakProgress: 0, breakingBlock: null, breakingBlockCanHarvest: false };
        let controls, raycaster;
        let highlightMesh, breakIndicatorMesh;
        const meshCache = {}; const activeMeshes = new Set();
        let audioContext; const sounds = {};
        const textureCache = {}; const TEXTURE_RESOLUTION = 16;
        const blockMaterials = {}; const blockGeometries = {};
        let waterMaterial, lavaMaterial, breakIndicatorMaterial;
        let currentOpenWindow = null; let currentInteractingBlock = null; let mousePosition = { x: 0, y: 0 };
        const noise = new SimplexNoise();
        const SAVE_KEY_PREFIX = 'mcUltimate_v1.6_'; // Incremented version
        const SAVE_KEY_PLAYER = SAVE_KEY_PREFIX + 'player'; const SAVE_KEY_TIME = SAVE_KEY_PREFIX + 'time'; const SAVE_KEY_META = SAVE_KEY_PREFIX + 'meta'; const SAVE_KEY_CHUNK_PREFIX = SAVE_KEY_PREFIX + 'chunk_';
        const uiState = { isMouseDownOnSlot: false, startDragSlotInfo: null };


        // =========================================================================
        // ==                       辅助函数库 (Final)                           ==
        // =========================================================================
        function $(selector) { return document.querySelector(selector); }
        function $$(selector) { return document.querySelectorAll(selector); }
        let messageTimeout = null;
        function showMessage(text, duration = 2000) { /* ... */ }
        function hideMessage() { /* ... */ }
        function setLoadingProgress(percentage, message, subtext = "") { /* ... */ }
        function updateInfoPanel() { /* ... */ }
        function formatTimeOfDay(ticks) { /* ... */ }
        // Coordinate Functions ...
        // Neighbor Offsets ...
        // Metadata Bit Helpers ...


        // =========================================================================
        // ==                         区块类 (Final)                              ==
        // =========================================================================
        class Chunk { /* ... */ }


        // =========================================================================
        // ==                      世界管理 (Final)                               ==
        // =========================================================================
        // ... (All Getters/Setters & Tile Entity Management) ...
        // --- Refined setBlock / setBlockMetadata ---


        // =========================================================================
        // ==                   世界生成 (Final)                                  ==
        // =========================================================================
        // ... BIOMES definition ...
        // ... Noise scale constants ...
        function getBiome(worldX, worldZ) { /* ... */ }
        function generateChunkData(chunk) { /* ... */ }
        function generateSimpleStructure(chunk, x, y, z, type) { /* ... */ }
        function generateTree(chunk, lx, y, lz, biome) { /* ... */ }
        function findHighestSolidBlock(worldX, worldZ, startY = CHUNK_HEIGHT - 1) { /* ... */ }


        // =========================================================================
        // ==                 区块加载/卸载 与 网格更新 (Final)                   ==
        // =========================================================================
        let chunkUpdateTimeout = null;
        function scheduleChunkUpdate() { /* ... */ }
        function updateChunksImmediate() { /* ... */ }
        function updateChunkMesh(chunk) { /* ... */ }
        function createBlockModel(blockId, metadata, worldX, worldY, worldZ) { /* ... */ }


        // =========================================================================
        // ==                  自定义着色器材质 (Final)                           ==
        // =========================================================================
        function createLitMaterial(originalMaterial) { /* ... */ }
        function updateShaderLightIntensity(skyIntensity, blockIntensity = 1.0) { /* ... */ }
        function initMaterials() { /* ... */ }
        function createBreakTexture() { /* ... */ }
        function updateBreakIndicator(progress, position, faceNormal) { /* ... */ }


        // =========================================================================
        // ==                      光照系统 (Final)                               ==
        // =========================================================================
        const MAX_LIGHT_UPDATES_PER_TICK = 25000;
        function processLightQueue() { /* ... */ }
        function addLightSource(x, y, z, emissionLevel) { /* ... */ }
        function removeLightSource(x, y, z, oldEmissionLevel) { /* ... */ }
        function recalculateLightingAround(x, y, z) { /* ... */ }


        // =========================================================================
        // ==                     日夜循环与天空 (Final)                          ==
        // =========================================================================
        function updateTimeOfDay(deltaTime) { /* ... */ }
        function getSkyLightLevelBasedOnTime(time = gameTime.timeOfDay) { /* ... */ }


        // =========================================================================
        // ==                 物理引擎与方块 Tick (Final)                       ==
        // =========================================================================
        const MAX_TICK_BLOCKS_PER_FRAME = 12000;
        function scheduleBlockTick(worldX, worldY, worldZ, delayTicks = 1) { /* ... */ }
        function processBlockTicks() { /* ... */ }
        function tickGravityBlock(x, y, z, blockId) { /* ... */ }
        function tickLiquidBlock(x, y, z, blockId, meta, props) { /* ... */ }
        function tickCropGrowth(x, y, z, blockId, meta, props) { /* ... */ }
        function tickRedstoneTorch(x, y, z, blockId) { /* ... */ }
        function tickButtonReset(x, y, z, meta) { /* ... */ }
        function tickFarmland(x, y, z, blockId) { /* ... */ }


        // =========================================================================
        // ==                      红石系统 (Final)                             ==
        // =========================================================================
        const MAX_POWER_UPDATES_PER_TICK = 15000;
        function schedulePowerUpdate(x, y, z) { /* ... */ }
        function processPowerQueue() { /* ... */ }
        function calculatePowerLevel(x, y, z) { /* ... */ }
        function getPowerFromNeighbor(nbX, nbY, nbZ, dirX, dirY, dirZ) { /* ... */ }
        function notifyNeighborsOfChange(x, y, z) { /* ... */ }
        function updatePowerAround(x, y, z) { /* ... */ }


        // =========================================================================
        // ==                     物品系统 & 库存管理 (Final)                     ==
        // =========================================================================
        // ... (All item/inventory functions) ...


        // =========================================================================
        // ==                          合成系统 (Final)                           ==
        // =========================================================================
        // RECIPES constant defined earlier...
        function checkCraftingRecipe() { /* ... */ }
        function checkWorkbenchRecipe() { /* ... */ }
        function findMatchingRecipe(gridItems, gridSize, requiresWorkbench = false) { /* ... */ }
        function handleCraftingOutputClick(event, outputItemRef, gridArrayRef, gridSize, inventoryName) { /* ... */ }
        function consumeCraftingIngredients(gridArrayRef, gridSize) { /* ... */ }


        // =========================================================================
        // ==                       熔炉 & 燃料系统 (Final)                       ==
        // =========================================================================
        // SMELTING_RECIPES and FUEL_SOURCES defined earlier...
        function tickFurnace(x, y, z, tileData) { /* ... */ }
        function handleFurnaceOutputClick(e) { /* ... */ }


        // =========================================================================
        // ==                     实体系统 (Final)                                ==
        // =========================================================================
        class DroppedItem { /* ... */ }
        class FallingBlock { /* ... */ } // ONLY definition here
        function spawnDroppedItem(blockId, position, count = 1, meta = 0) { /* ... */ }
        function updateEntities(deltaTime) { /* ... */ }


        // =========================================================================
        // ==                   玩家控制与物理 (Final)                            ==
        // =========================================================================
        // ... (All player control and physics functions) ...


        // =========================================================================
        // ==                     交互与 UI (Final)                               ==
        // =========================================================================
        // ... (All UI interaction functions) ...


        // =========================================================================
        // ==                     主循环与初始化 (Final)                          ==
        // =========================================================================
        function initThreeJS() { /* ... */ }
        function initAudio() { /* ... */ }
        function initMaterials() { /* ... */ }
        // ...

        async function initializeGame() { /* ... */ }
        function updateLoadingProgress(chunkKeyOrPercent, phaseMessage, subtext="") { /* ... */ }
        function animate() { /* ... */ }
        function tickTileEntities() { /* ... */ }
        function onWindowResize() { /* ... */ }


        // =========================================================================
        // ==                     保存与加载 (Final)                              ==
        // =========================================================================
        async function saveGameState() { /* ... */ }
        async function loadGameState() { /* ... */ }


        // =========================================================================
        // ==                     启动 / 纹理 / 音频 (Final)                      ==
        // =========================================================================
        function generateTexture(type) { /* ... (MASSIVE function) ... */ }
        function getBlockMaterial(blockId) { /* ... */ }
        function initAudio() { /* ... */ }
        function preloadSounds() { /* ... */ }
        function createSynthSound(config) { /* ... */ }
        function playSound(soundName, blockId = null) { /* ... */ }

        // --- Final Startup & Error Handling ---
        if (typeof THREE === 'undefined' || typeof SimplexNoise === 'undefined') {
             console.error("依赖库未能加载!"); setLoadingProgress(100, "错误：核心库加载失败！", "请检查网络连接或浏览器控制台。");
        } else {
             try { setTimeout(initializeGame, 150); } catch (error) { /* ... Error Handling ... */ }
        }

        console.log(`[CORE] Estimated Code Lines (v1.6 - Final Order Fix): ${document.documentElement.innerHTML.split('\n').length}`);

    </script>
</body>
</html>
